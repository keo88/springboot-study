name: Auto Sync Cursor Rules

on:
  repository_dispatch:
    types: [cursor-rules-updated]
  
  workflow_dispatch:

env:
  TARGET_REPO: 'keo88/universal-cursor-rules'
  TARGET_BRANCH: 'main'
  LOCAL_BRANCH: 'develop'
  RULES_DIR: '.cursor/rules'
  SOURCE_DIR: 'java'
  
  # ë³µì‚¬í•  íŒŒì¼ íŒ¨í„´ (ê³µë°±ìœ¼ë¡œ êµ¬ë¶„)
  FILE_PATTERNS: '*.mdc *.md'

jobs:
  sync-cursor-rules:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout and sync
      uses: actions/checkout@v4
      with:
        ref: ${{ env.LOCAL_BRANCH }}
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Download and apply rules
      run: |
        # Git ì„¤ì •
        git config user.name 'github-actions[bot]'
        git config user.email 'github-actions[bot]@users.noreply.github.com'
        
        # íƒ€ê²Ÿ ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p ${{ env.RULES_DIR }}
        
        # ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ ê²½ë¡œ ì„¤ì •
        if [ -n "${{ env.SOURCE_DIR }}" ]; then
          SOURCE_PATH="${{ env.SOURCE_DIR }}"
          echo "Syncing from source directory: $SOURCE_PATH"
        else
          SOURCE_PATH=""
          echo "Syncing from repository root"
        fi
        
        # íŒŒì¼ íŒ¨í„´ ë°°ì—´ë¡œ ë³€í™˜
        IFS=' ' read -ra PATTERNS <<< "${{ env.FILE_PATTERNS }}"
        
        # ê° íŒ¨í„´ì— ëŒ€í•´ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        for pattern in "${PATTERNS[@]}"; do
          echo "Downloading files matching pattern: $pattern"
          
          # API ê²½ë¡œ ì„¤ì •
          if [ -n "$SOURCE_PATH" ]; then
            API_URL="https://api.github.com/repos/${{ env.TARGET_REPO }}/contents/$SOURCE_PATH"
          else
            API_URL="https://api.github.com/repos/${{ env.TARGET_REPO }}/contents"
          fi
          
          # íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (íŒ¨í„´ ë§¤ì¹­)
          FILES=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "$API_URL" \
            | jq -r --arg pattern "$pattern" '.[] | select(.type == "file" and (.name | test($pattern | gsub("\\*"; ".*") | gsub("\\?"; ".")))) | .name')
          
          # íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          for file in $FILES; do
            if [ -n "$file" ]; then
              echo "  â†’ Downloading: $file"
              
              if [ -n "$SOURCE_PATH" ]; then
                DOWNLOAD_URL="https://api.github.com/repos/${{ env.TARGET_REPO }}/contents/$SOURCE_PATH/$file"
              else
                DOWNLOAD_URL="https://api.github.com/repos/${{ env.TARGET_REPO }}/contents/$file"
              fi
              
              curl -s \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github.v3.raw" \
                "$DOWNLOAD_URL" \
                -o "${{ env.RULES_DIR }}/$file"
            fi
          done
        done
        
        # ë‹¤ìš´ë¡œë“œëœ íŒŒì¼ í™•ì¸
        echo "ğŸ“ Files in ${{ env.RULES_DIR }}:"
        ls -la ${{ env.RULES_DIR }}/ || echo "No files found"
        
        # ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
        git add ${{ env.RULES_DIR }}
        
        if ! git diff --cached --quiet; then
          git commit -m "ğŸ”„ Auto-sync cursor rules from ${{ env.TARGET_REPO }}
          
          Source: ${{ env.TARGET_REPO }}/${{ env.SOURCE_DIR || 'root' }}
          Patterns: ${{ env.FILE_PATTERNS }}
          Branch: ${{ env.TARGET_BRANCH }} â†’ ${{ env.LOCAL_BRANCH }}"
          
          git push origin ${{ env.LOCAL_BRANCH }}
          echo "âœ… Changes committed and pushed to ${{ env.LOCAL_BRANCH }}"
        else
          echo "â„¹ï¸ No changes detected"
        fi
