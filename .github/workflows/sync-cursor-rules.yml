name: Auto Sync Cursor Rules

on:
  # ì†ŒìŠ¤ ë¦¬í¬ì§€í† ë¦¬ë¡œë¶€í„° íŒŒì¼ ë°ì´í„° ìˆ˜ì‹ 
  repository_dispatch:
    types: [cursor-rules-updated]
  
  # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜
  workflow_dispatch:

env:
  LOCAL_BRANCH: 'main'           # ë¡œì»¬ íƒ€ê²Ÿ ë¸Œëœì¹˜
  RULES_DIR: '.cursor/rules'        # ë¡œì»¬ ì €ì¥ ê²½ë¡œ
  
  # í•„í„°ë§ ì„¤ì • (í•„ìš”í•œ ê²ƒë§Œ ì„ íƒ)
  INCLUDE_DIRECTORIES: 'java'           # ì˜ˆ: 'python frontend/react' (ê³µë°± êµ¬ë¶„)
  INCLUDE_PATTERNS: '*.mdc'         # ì˜ˆ: '*.mdc *.md' (ê³µë°± êµ¬ë¶„)  
  INCLUDE_TAGS: ''                  # ì˜ˆ: 'python react' (ê³µë°± êµ¬ë¶„)
  EXCLUDE_PATTERNS: ''             # ì˜ˆ: 'temp_*.mdc draft_*.md' (ê³µë°± êµ¬ë¶„)

jobs:
  sync-cursor-rules:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ env.LOCAL_BRANCH }}
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Process and apply rules
      run: |
        # Git ì„¤ì •
        git config user.name 'github-actions[bot]'
        git config user.email 'github-actions[bot]@users.noreply.github.com'
        
        # íƒ€ê²Ÿ ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p ${{ env.RULES_DIR }}
        
        # í˜ì´ë¡œë“œì—ì„œ íŒŒì¼ ì •ë³´ ì¶”ì¶œ
        echo "ğŸ“¦ Processing payload from repository_dispatch..."
        
        # í˜ì´ë¡œë“œ íŒŒì¼ ìƒì„± (GitHubì´ í™˜ê²½ ë³€ìˆ˜ë¡œ ì „ë‹¬)
        echo '${{ github.event.client_payload }}' > payload.json
        
        # í˜ì´ë¡œë“œ ë‚´ìš© í™•ì¸
        echo "ğŸ“„ Received payload:"
        cat payload.json | jq .
        
        # í•„í„°ë§ ì¡°ê±´ ì„¤ì •
        INCLUDE_DIRS="${{ env.INCLUDE_DIRECTORIES }}"
        INCLUDE_PATS="${{ env.INCLUDE_PATTERNS }}"
        INCLUDE_TAGS_LIST="${{ env.INCLUDE_TAGS }}"
        EXCLUDE_PATS="${{ env.EXCLUDE_PATTERNS }}"
        
        echo "ğŸ” Filtering rules:"
        echo "  Include directories: $INCLUDE_DIRS"
        echo "  Include patterns: $INCLUDE_PATS"
        echo "  Include tags: $INCLUDE_TAGS_LIST"
        echo "  Exclude patterns: $EXCLUDE_PATS"
        
        # íŒŒì¼ í•„í„°ë§ ë° ì €ì¥
        echo "ğŸ“ Applying filtered rules..."
        
        # jqë¡œ íŒŒì¼ ë°°ì—´ ìˆœíšŒ
        cat payload.json | jq -c '.files[]' | while read -r file; do
          # íŒŒì¼ ì •ë³´ ì¶”ì¶œ
          name=$(echo "$file" | jq -r '.name')
          path=$(echo "$file" | jq -r '.path')
          directory=$(echo "$file" | jq -r '.directory')
          content=$(echo "$file" | jq -r '.content')
          tags=$(echo "$file" | jq -r '.tags[]?' | tr '\n' ' ')
          
          echo "  â†’ Processing: $name (dir: $directory)"
          
          # í•„í„°ë§ ë¡œì§
          should_include=true
          
          # 1. ë””ë ‰í† ë¦¬ í•„í„°ë§
          if [ -n "$INCLUDE_DIRS" ]; then
            match_found=false
            for dir in $INCLUDE_DIRS; do
              if [[ "$directory" == "$dir"* ]] || [[ "$directory" == "root" && "$dir" == "." ]]; then
                match_found=true
                break
              fi
            done
            if [ "$match_found" = false ]; then
              should_include=false
              echo "    âŒ Directory filter: $directory not in [$INCLUDE_DIRS]"
            fi
          fi
          
          # 2. íŒŒì¼ íŒ¨í„´ í•„í„°ë§ (í¬í•¨)
          if [ "$should_include" = true ] && [ -n "$INCLUDE_PATS" ]; then
            match_found=false
            for pattern in $INCLUDE_PATS; do
              if [[ "$name" == $pattern ]]; then
                match_found=true
                break
              fi
            done
            if [ "$match_found" = false ]; then
              should_include=false
              echo "    âŒ Pattern filter: $name not matching [$INCLUDE_PATS]"
            fi
          fi
          
          # 3. íƒœê·¸ í•„í„°ë§
          if [ "$should_include" = true ] && [ -n "$INCLUDE_TAGS_LIST" ]; then
            match_found=false
            for tag in $INCLUDE_TAGS_LIST; do
              if [[ "$tags" == *"$tag"* ]]; then
                match_found=true
                break
              fi
            done
            if [ "$match_found" = false ]; then
              should_include=false
              echo "    âŒ Tag filter: [$tags] not containing [$INCLUDE_TAGS_LIST]"
            fi
          fi
          
          # 4. ì œì™¸ íŒ¨í„´ í•„í„°ë§
          if [ "$should_include" = true ] && [ -n "$EXCLUDE_PATS" ]; then
            for pattern in $EXCLUDE_PATS; do
              if [[ "$name" == $pattern ]]; then
                should_include=false
                echo "    âŒ Exclude pattern: $name matching $pattern"
                break
              fi
            done
          fi
          
          # íŒŒì¼ ì €ì¥
          if [ "$should_include" = true ]; then
            echo "    âœ… Including: $name"
            echo "$content" > "${{ env.RULES_DIR }}/$name"
          else
            echo "    â­ï¸  Skipping: $name"
          fi
        done
        
        # ê²°ê³¼ í™•ì¸
        echo "ğŸ“ Files in ${{ env.RULES_DIR }}:"
        ls -la ${{ env.RULES_DIR }}/ || echo "No files found"
        
        # ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
        git add ${{ env.RULES_DIR }}
        
        if ! git diff --cached --quiet; then
          # ì†ŒìŠ¤ ì •ë³´ ì¶”ì¶œ
          source_repo=$(echo '${{ github.event.client_payload }}' | jq -r '.commit.sha // "unknown"')
          source_commit=$(echo '${{ github.event.client_payload }}' | jq -r '.commit.sha // "unknown"')
          
          git commit -m "ğŸ”„ Auto-sync filtered cursor rules

          Source commit: $source_commit
          Filters applied:
          - Directories: $INCLUDE_DIRS
          - Patterns: $INCLUDE_PATS  
          - Tags: $INCLUDE_TAGS_LIST
          - Exclude: $EXCLUDE_PATS
          
          Files updated: $(ls ${{ env.RULES_DIR }}/ | wc -l)"
          
          git push origin ${{ env.LOCAL_BRANCH }}
          echo "âœ… Changes committed and pushed to ${{ env.LOCAL_BRANCH }}"
        else
          echo "â„¹ï¸ No changes detected after filtering"
        fi
